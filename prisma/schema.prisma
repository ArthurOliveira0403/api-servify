generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      =  env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  COMPANY
}

model Admin {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  role     UserRole @default(ADMIN)

  @@map("admin")
}

model Company {
  id                 String         @id @default(uuid())
  name               String
  email              String         @unique 
  password           String   
  cnpj               String         @unique
  address            Address?
  phone_number       String?
  role               UserRole       @default(COMPANY)
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  
  services           Service[]
  clientsCompany     ClientCompany[]
  servicesExecutions ServiceExecution[]
  subscriptions      Subscription[]

  @@map("company")
}

model Address {
  company_id String  @unique
  country    String?
  state      String?
  city       String?
  street     String?
  number     String?
  zip_code   String?
  complement String?

  company    Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("address")
}

model Client {
  id               String         @id @default(uuid())
  full_name        String
  international_id String         @unique
  created_at       DateTime       @default(now())

  clientsCompanys ClientCompany[]
  
  @@map("client")
}

model ClientCompany {
  id                 String             @id @default(uuid())
  company_id         String
  client_id          String   
  email              String?
  phone              String?
  created_at         DateTime           @default(now())
  updated_at         DateTime           @updatedAt

  company            Company            @relation(fields: [company_id], references: [id], onDelete: Cascade)
  client             Client             @relation(fields: [client_id], references: [id], onDelete: Cascade)
  servicesExecutions ServiceExecution[]
  @@map("client_company")
}

model Service {
  id                 String             @id @default(uuid())
  company_id         String 
  name               String             
  description        String
  base_price         Int                // cents
  created_at         DateTime           @default(now())
  updated_at         DateTime           @updatedAt 

  company            Company            @relation(fields: [company_id], references: [id], onDelete: Cascade)
  servicesExecutions ServiceExecution[]

  @@map("service")
}

enum ServiceExecutionStatus {
  PENDING 
  DONE 
  CANCELED
}

model ServiceExecution {
  id                         String                  @id @default(uuid())
  company_id                 String
  service_id                 String
  client_company_id          String 
  executed_at                DateTime                @default(now())
  price                      Int                     // cents
  status                     ServiceExecutionStatus

  company                    Company                @relation(fields: [company_id], references: [id], onDelete: Cascade)
  service                    Service                @relation(fields: [service_id], references: [id], onDelete: Cascade)
  clientCompany              ClientCompany          @relation(fields: [client_company_id], references: [id], onDelete: Cascade)
  invoices                   Invoice[]       

  @@map("service_execution")
}

enum InvoiceStatus {
  VALID
  INVALID
}

model Invoice {
  id                      String           @id @default(uuid())
  company_name            String
  company_cnpj            String
  company_phone           String?
  client_name             String
  client_international_id String
  client_phone            String?
  service_execution_id    String
  service_name            String
  service_description     String
  executed_at             DateTime
  price                   Int              // cents
  issued_at               DateTime         // UTC
  status                  InvoiceStatus    @default(VALID)
  invoice_number          String
  pdf_path                String?
  timezone                String           
  created_at              DateTime         @default(now()) // UTC
  updated_at              DateTime         @updatedAt // UTC

  service                 ServiceExecution @relation(fields: [service_execution_id], references: [id])

  @@map("invoice")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
}

model Subscription {
  id           String             @id @default(uuid())
  company_id   String          
  plan_id      String
  price        Int
  status       SubscriptionStatus
  start_date   DateTime
  end_date     DateTime
  renewal_date DateTime

  company      Company            @relation(fields: [company_id], references: [id], onDelete: Cascade)
  plan         Plan               @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  
  @@map("subscription")
}

enum PlanType {
  MONTHLY
  YEARLY
}

model Plan {
  id            String         @id
  name          String         @unique
  type          PlanType
  price         Int
  description   String
  subscriptions Subscription[]

  @@map("plan")
}